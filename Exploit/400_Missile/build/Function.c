/*
 * Function.c
 *
 *  Created on: 2016. 10. 26.
 *      Author: jeongyoungmin
 */

#include "Global.h"
#include "Function.h"
#include "Operator.h"
#include "Admin.h"

char functionsName[MAXFUNC-1][STRLEN] = {"Weapon management", "Missile management","Operator management","Function Setting"};

void FunctionalModification(){
	unsigned int cnt;
	unsigned int len;
	char number[2];

	printf("Function Number : ");
	UserInput(number, 2);

	cnt = atoi(number);
	if(cnt < MAXFUNC - 1){
		if(menu[cnt -1]->state != 0){
			printf("Function Name : ");
			UserInput(menu[cnt]->functionName, STRLEN);
		}else{
			printf("Fail\n");
		}
	}
}

void FunctionDelete(){
	unsigned int cnt;
	char number[2];

	printf("Function Number : ");
	UserInput(number, 2);
	
	printf("Check Point : %d\n",atoi(number));
	cnt = atoi(number);
	if(0 < cnt && cnt < MAXFUNC - 1){
		if(menu[cnt -1]->state != 0){
			menu[cnt - 1]->state = 0;
 			free(menu[cnt - 1]);
		}else{
			printf("Fail!\n");
		}
	}
}

void AddFunctions(){	
	char *test;	
	char tmp[51];
	char number[2];
	unsigned int cnt;

	if(OperatorCheck()){
		if(state->requestCnt < MAXCNT){
			request[state->requestCnt] = (Request*)malloc(sizeof(request));
			test = (char*)malloc(40);

			while(1){
				printf("Add Operator number : ");
				UserInput(number, 2);
				
				cnt = atoi(number);
				if(cnt < state->operatorCnt){
					if(operator[cnt]->state != 0){
						request[state->requestCnt]->operatorNumber = cnt;
						break;
					}else{
						printf("Fail : Is not activated.\n");
					}
				}else{
					printf("0 ~ %d\n",state->operatorCnt - 1);
				}
			}		
			
			printf("Add Function Name : ");
			memset(tmp,0,51);
			UserInput(tmp, 40);			

			cnt = strlen(tmp);
			//check point
			strncpy(test,tmp,cnt);
			strncpy(request[state->requestCnt]->functionName, test, cnt);	

			memset(test,0,21);			

			printf("Reasons : ");
			memset(tmp,0,51);
			UserInput(request[state->requestCnt]->reasons, 51);
			
			request[state->requestCnt]->state = 1;
			state->requestCnt++;
		}else{
			printf("Input 0 ~ %d\n",state->operatorCnt - 1);
		}
	}else{
		printf("Operator Add!\n");
	}
}

void FunctionSetting(){
	unsigned int cnt;
	unsigned int control = 1;
	char number[2];
	char functTitle[MAXFUNC][30] = {"1) Functional modification\n","2) Delete Function\n","3) Add Function\n","4) Request List\n","5) Exit\n"};

	while(control){
		alarm(SIGALARMTIME);
		for(cnt = 0;cnt < MAXFUNC;cnt++){
			printf("%s",functTitle[cnt]);
		}

		printf("Command : ");
		if(UserInput(number, 2)){
			switch(atoi(number)){
				case 1:
					//Functional Modification
					FunctionalModification();
					break;
				case 2:
					//Function Delete
					FunctionDelete();
					break;
				case 3:
					//Add Function
					AddFunctions();
					break;
				case 4:
					RequestList();
					break;
				case 5:
					control = 0;
					break;
				default:
					break;
			}
		}
	}
}

void FunctionList(){
	unsigned int cnt;
	for(cnt = 0;cnt < MAXFUNC - 1;cnt++){
		printf("%d) %s\n",cnt+1,menu[cnt]->functionName);
	}
	printf("%d) %s\n",cnt+1,"Exit");
}

void FuncDefSetting(void** functionsAddr){
	unsigned int cnt;

	state = (State*)malloc(sizeof(state));
	state->weaponCnt = 0;
	state->missileCnt = 0;
	state->operatorCnt = 0;
	state->requestCnt = 0;

	weapon = (Weapon**)malloc(sizeof(Weapon*) * 100);
	missile = (Missile**)malloc(sizeof(Missile*) * 100);
	operator = (Operator**)malloc(sizeof(Operator*) * 100);
	request = (Request**)malloc(sizeof(Request*) * 100);

	menu = (Menu**)malloc(sizeof(Menu*) * MAXFUNC - 1);
	//printf(">>>> %ld\n",sizeof(Menu));
	for(cnt = 0;cnt < MAXFUNC - 1;cnt++){
		menu[cnt] = (Menu*)malloc(sizeof(Menu));	
		strcpy(menu[cnt]->functionName, functionsName[cnt]);
		menu[cnt]->state = 1;
		menu[cnt]->FuncPtr = functionsAddr[cnt];
	}
}
