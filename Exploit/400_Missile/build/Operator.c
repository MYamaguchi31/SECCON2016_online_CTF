/*
 * Operator.c
 *
 *  Created on: 2016. 10. 25.
 *      Author: jeongyoungmin
 */

#include "Global.h"
#include "Operator.h"
#include "UserInput.h"

unsigned int OperatorCheck(){
	unsigned int cnt;
	unsigned int activation = 0;

	if(state->operatorCnt){
		for(cnt = 0;cnt < state->operatorCnt; cnt++){
			if(operator[cnt]->state == 1){
				activation++;
			}
		}
	}
	return activation;
}


void OperatorList(){
	unsigned int cnt;
	for(cnt = 0;cnt < state->operatorCnt;cnt++){
		if(operator[cnt]->state != 0){
			printf("Operator Number\t: %d\n",cnt);
			printf("Operator Name\t: %s\n",operator[cnt]->name);
			printf("Operator Part\t: %s\n",operator[cnt]->part);
			printf("Operator Rank\t: %s\n",operator[cnt]->rank);
			printf("\n");
		}
	}
}

void OperatorAdd(){
	unsigned int cnt;
	unsigned int len;

	if(state->operatorCnt != 0){
		for(cnt = 0;cnt < state->operatorCnt; cnt++){
			if(operator[cnt]->state == 0){
				break;
			}
		}
	}else{
		cnt = 0;
	}

	if(cnt < MAXCNT){
		operator[cnt] = (Operator*)mmap( NULL, sizeof(Operator), PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
		
		if (mprotect(operator[cnt]->name, 60, PROT_READ | PROT_WRITE | PROT_EXEC)) { 
			perror(mprotect);
			exit(errno); 
		}

		printf("Operator Name : ");
		UserInput(operator[cnt]->name, STRLEN);

		printf("Operator Part : ");
		UserInput(operator[cnt]->part, STRLEN);


		printf("Operator Rank : ");
		UserInput(operator[cnt]->rank, STRLEN);

		operator[cnt]->state = 1;

		if(cnt == state->operatorCnt){
			if(state->operatorCnt != MAXCNT){
				state->operatorCnt++;
			}
		}

	}else{
		printf("Full\n");
	}
}

void OperatorModification(){
	char number[3];
	unsigned int cnt;
	unsigned int size;
	unsigned int len;

	printf("Operator Number : ");
	UserInput(number, 2);

	cnt = atoi(number);
	if(cnt < state->operatorCnt){
		if(operator[cnt]->state != 0){
			printf("Operator Number\t: %d\n",cnt);
			printf("Operator Name\t: %s\n",operator[cnt]->name);
			printf("Operator Part \t: %s\n",operator[cnt]->part);
			printf("Operator Rank \t: %s\n\n",operator[cnt]->rank);

			memset(operator[cnt]->name,0,STRLEN);
			memset(operator[cnt]->part,0,STRLEN);
			memset(operator[cnt]->rank,0,STRLEN);
		
			printf("Operator Name : ");
			UserInput(operator[cnt]->name, STRLEN);			

			printf("Operator part : ");
			UserInput(operator[cnt]->part, STRLEN);

			printf("Operator Rank : ");
			UserInput(operator[cnt]->rank, STRLEN);
		}
	}else{
		printf("Input 0 ~ %d\n",state->operatorCnt - 1);
	}
}

void OperatorManagement()
{
	char number[2];
	unsigned int control = 1;

	char operatorFuncName[MAXFUNC-1][STRLEN] = {"Operator List", "Operator Add","Operator Mod","Exit"};

	printf("Operator Management\n");
	while(control){
		alarm(SIGALARMTIME);
		int cnt;
		for(cnt =0;cnt < MAXFUNC-1;cnt++){
			printf("%d) %s\n",cnt+1,operatorFuncName[cnt]);
		}

		printf("Command : ");
		if(UserInput(number, 2)){
			switch(atoi(number)){
				case 1:
					//List
					OperatorList();
					break;
				case 2:
					//Add
					OperatorAdd();
					break;
				case 3:
					//Mod
					OperatorModification();
					break;
				case 4:
					control = 0;
					break;
				default:
					break;
			}
		}
	}
}
