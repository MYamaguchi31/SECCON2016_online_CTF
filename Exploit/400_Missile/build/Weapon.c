#include "Global.h"
#include "Weapon.h"

void WaaponList(){
	unsigned int cnt;
	for(cnt = 0;cnt < state->weaponCnt;cnt++){
		if(weapon[cnt]->state != 0){
			printf("Weapon Number\t: %d\n",cnt);
			printf("Weapon Name\t: %s\n",weapon[cnt]->name);
			printf("Weapon Location\t: %s\n",weapon[cnt]->location);
			printf("\n");
		}
	}
}

void WeaponAdd(){
	unsigned int cnt;
	unsigned int len;
	unsigned int size;
	char number[2];

	if(OperatorCheck()){
		if(state->weaponCnt != 0){
			for(cnt = 0;cnt < state->weaponCnt; cnt++){
				if(weapon[cnt]->state == 0){
					break;
				}
			}
		}else{
			cnt = 0;
		}

		if(cnt < MAXCNT){
			weapon[cnt] = (Weapon*)malloc(sizeof(Weapon));
			weapon[cnt]->state = 1;

			size = STRLEN - 1;

			memset(weapon[cnt]->name,0,size);
			memset(weapon[cnt]->location,0,size);

			while(1){
				printf("Add Operator number : ");
				UserInput(number, 2);
				cnt = atoi(number);
				if(cnt < state->operatorCnt){
					if(operator[cnt]->state != 0){
						weapon[cnt]->operator = operator[cnt];
						break;
					}else{
						printf("Fail : Is not activated.\n");
					}
				}else{
					printf("0 ~ %d\n",state->operatorCnt - 1);
				}
			}	
	
			printf("Weapon Name : ");
			UserInput(weapon[cnt]->name, STRLEN);

			printf("Weapon Location : ");
			UserInput(weapon[cnt]->location, 33);

			if(cnt == state->weaponCnt){
				if(state->weaponCnt != MAXCNT){
					state->weaponCnt++;
				}
			}
			
			
		}else{
			printf("Full\n");
		}
	}else{
		printf("Add Operator!\n");
	}
}

void WeaponModification(){
	char number[3];
	unsigned int cnt;
	unsigned int size;
	unsigned int len;

	printf("Weapon Number : ");
	fflush(0);
	UserInput(number, 2);	

	cnt = atoi(number);
	if(cnt < state->weaponCnt){
		if(weapon[cnt]->state != 0){
			printf("Weapon Number\t: %d\n",cnt);
			printf("Weapon Name\t: %s\n",weapon[cnt]->name);
			printf("Weapon Location\t: %s\n\n",weapon[cnt]->location);

			size = sizeof(weapon[cnt]->name) - 1;
			
			memset(weapon[cnt]->name,0,STRLEN);
			memset(weapon[cnt]->location,0,STRLEN);

			printf("Weapon Name : ");
			UserInput(weapon[cnt]->name, STRLEN);

			printf("Weapon Location : ");
			UserInput(weapon[cnt]->location, STRLEN);
		}
	}else{
		printf("Input 0 ~ %d\n",state->weaponCnt - 1);
	}
}

void WeaponDelete(){
	char number[3];
	unsigned int cnt;

	printf("Weapon Number : ");
	fflush(0);
	UserInput(number, 2);

	cnt = atoi(number);
	if(cnt < state->weaponCnt){
		printf("%d\n",cnt);
		if(weapon[cnt]->state != 0){
			weapon[cnt]->state = 0;
			free(weapon[cnt]);
		}else{
			printf("Fail!\n");
		}
	}else{
		printf("Fail!\n");
	}
}

void WeaponManagement()
{
	char number[2];
	unsigned int control = 1;

	char weaponFuncName[MAXFUNC][STRLEN] = {"Weapon List", "Weapon Add","Weapon Mod","Weapon Del","Exit"};

	printf("Weapon Management\n");
	while(control){
		alarm(SIGALARMTIME);
		int cnt;
		for(cnt =0;cnt < MAXFUNC;cnt++){
			printf("%d) %s\n",cnt+1,weaponFuncName[cnt]);
		}
		printf("Command : ");
		fflush(0);
		if(UserInput(number, 2)){
			switch(atoi(number)){
				case 1:
					//List
					WaaponList();
					break;
				case 2:
					//Add
					WeaponAdd();
					break;
				case 3:
					//Mod
					WeaponModification();
					break;
				case 4:
					//Del
					WeaponDelete();
					break;
				case 5:
					control = 0;
					break;
				default:
					break;
			}
		}
	}
}
