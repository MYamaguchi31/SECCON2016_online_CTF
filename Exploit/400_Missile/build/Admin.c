/*
 * Admin.c
 *
 *  Created on: 2016. 10. 25.
 *      Author: jeongyoungmin
 */

#include <time.h>
#include "Global.h"
#include "Admin.h"

unsigned int otp;
unsigned int max = 4;


void OTP(){
	srand(time(NULL));
	otp = rand();
}

void PrintOTP(){
	printf("OTP : %d\n",otp);
}

int OTPCheck(){
	char input[11];
	unsigned int password;

	printf("Enter OTP number.\n");
	printf("OTP : ");
	fflush(0);
	UserInput(input, 11);
	
	password = atoi(input);

	if(otp == password){
		return 1;
	}else{
		printf("It does not match.\n");
		exit(0);
	}

}

void RequestList(){
	if(state->requestCnt){
		int cnt;
		for(cnt = 0;cnt <state->requestCnt; cnt++){
			printf("\n==========================================\n");
			printf("||\t\tRequests list\t\t||\n");
			printf("==========================================\n");

			printf("Request number : %d\n",cnt);
			printf("Add Function Name : %s\n",request[cnt]->functionName);
			printf("Add Operator Number : %d\n",request[cnt]->operatorNumber);
			printf("Reasons : %s\n",request[cnt]->reasons);
			printf("Request state : %d\n\n",request[cnt]->state);
		}
	}
}

void ApprovalSystem(unsigned int cnt, char *comment){	
	char number[2];
	int result;
	char tmp[100];

	printf("1) Approve, 2) Reject\n");
	while(1){
		printf("Input value : ");
		memset(number,0,2);
		fflush(0);
		UserInput(number, 2);
		
		result = atoi(number);
		if(result == 1){
			request[cnt]->state = 2;
			if(OTPCheck()){
				strncpy(comment,request[cnt]->reasons,strlen(request[cnt]->reasons));
				printf("Add comment : ");
				fflush(0);
				UserInput(tmp, 100);
				
				strcat(comment,tmp);
				strncpy(request[cnt]->reasons,tmp,strlen(tmp));
			}
			break;
		}else if(result == 2){
			request[cnt]->state = 0;
			printf("Rejected.\n");
			break;
		}else{
			printf("Error : Input value error.\n");
		}
	}
}

void AdminReview(){
	char comment[50];
	char number[2];
	unsigned int cnt;
	unsigned int opCnt;

	printf("Select what you want to review.\n");
	printf("Number : ");
	fflush(0);
	UserInput(number, 2);
	
	cnt = atoi(number);
	if(state->requestCnt){
		if(request[cnt]->state == 1){
			printf("\n==========================================\n");
			printf("||\t\tRequests list\t\t||\n");
			printf("==========================================\n");

			printf("Request number : %d\n",cnt);
			printf("Add Function Name : %s\n",request[cnt]->functionName);
			printf("Operator Number : %d\n",request[cnt]->operatorNumber);

			opCnt = request[cnt]->operatorNumber;

			printf("\tOperator Name\t: %s\n",operator[opCnt]->name);
			printf("\tOperator Rart\t: %s\n",operator[opCnt]->part);
			printf("\tOperator Rank\t: %s\n",operator[opCnt]->rank);

			printf("Reasons : %s\n",request[cnt]->reasons);
			printf("Request state : %d\n\n",request[cnt]->state);
			printf("==========================================\n");
			
			ApprovalSystem(cnt,comment);

		}else if(request[cnt]->state == 2){
			printf("This item has already been approved.\n");
		}else if(request[cnt]->state == 0){
			printf("This item has already been rejected.\n");
		}else{
			printf("Error!!!!\n");
		}
	}
}

void AdminSystem(){
	unsigned int cnt;
	unsigned int control = 1;
	char functTitle[MAXFUNC][30] = {"1) Request list\n","2) Request review\n","3) Create OTP\n","4) Exit\n"};			
	char number[2];

	while(control){	
		alarm(SIGALARMTIME);		
		for(cnt = 0;cnt < max;cnt++){
			printf("%s",functTitle[cnt]);
		}

		printf("Command : ");
		fflush(0);
		if(UserInput(number, 2)){
			switch(atoi(number)){
				case 1:
					//Functional Modification
					RequestList();
					break;
				case 2:
					//Function Delete
					AdminReview();
					break;
				case 3:
					OTP();
					PrintOTP();
					break;
				case 4:
					control = 0;
					break;
				default:
					break;
			}
		}
	}
}
