#include <stdio.h>
#include <stdlib.h>
#include <setjmp.h>
#include <malloc.h>
#define N 32
/* gcc jmper.c -o jmper -Wl,-z,relro,-z,now */

/* off-by-one -> name's pointer will be overwritten to jmpbuf pointer */
struct Student{
    unsigned long id;
    char memo[N];
    char *name;
};

/* person's num >= 31 -> exception with longjmp */
struct Class{
    struct Student *students[30];
};
struct Class *my_class;
int student_num;

jmp_buf *jmpbuf;

void f(void){
    int i, id, input;
    struct Student *student;
    char *name, c, *ptr;
    student_num = 0;
    while(1){
        puts("1. Add student.\n2. Name student.\n3. Write memo\n4. Show Name\n5. Show memo.\n6. Bye :)");
        scanf("%d",&input);getchar();
        if(input == 1){
            if(student_num >= 30){
                puts("Exception has occurred. Jump!");
                longjmp(*jmpbuf, 114514);
            }
            student = (struct Student *)malloc(sizeof(struct Student));
            student->id = student_num;
            student->name = (char *)malloc(N);
            my_class->students[student_num] = student;
            student_num++;
        }else if(input == 2){
            printf("%s","ID:");
            scanf("%d",&id);getchar();
            if(id >= student_num || id < 0){
                puts("Invalid ID.");
                exit(1);
            }
            printf("%s","Input name:");
            ptr = (my_class->students[id])->name;
            for(i=0;i<=N;i++){
                c = getchar();
                if(c == '\n')break;
                *ptr = c;
                ptr++;
            }
        }else if(input == 3){
            printf("%s","ID:");
            scanf("%d",&id);getchar();
            if(id >= student_num || id < 0){
                puts("Invalid ID.");
                exit(1);
            }
            printf("%s","Input memo:");
            ptr = (my_class->students[id])->memo;
            for(i=0;i<=N;i++){
                c = getchar();
                if(c == '\n')break;
                *ptr = c;
                ptr++;
            }
        }else if(input == 4){
            printf("%s","ID:");
            scanf("%d",&id);getchar();
            if(id >= student_num || id < 0){
                puts("Invalid ID.");
                exit(1);
            }
            printf("%s",(my_class->students[id])->name);
        }else if(input == 5){
            printf("%s","ID:");
            scanf("%d",&id);getchar();
            if(id >= student_num || id < 0){
                puts("Invalid ID.");
                exit(1);
            }
            printf("%s",(my_class->students[id])->memo);
        }else{
            exit(0);
        }
    }
}

int main(){
    int d;
    setvbuf(stdin, 0, _IONBF, 0);
    setvbuf(stdout, 0, _IONBF, 0);
    puts("Welcome to my class.");
    puts("My class is up to 30 people :)");
    my_class = (struct Class *)malloc(sizeof(struct Class));
    jmpbuf = (jmp_buf *)malloc(sizeof(jmp_buf));
    d = setjmp(*jmpbuf);
    if(d == 0){
        f();
    }else{
        puts("Nice jump! Bye :)");
    }
    return 0;
}
